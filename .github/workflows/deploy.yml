name: Auto Deploy to Aliyun Server

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Aliyun Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ALIYUN_HOST }}
        username: ${{ secrets.ALIYUN_USER }}
        key: ${{ secrets.ALIYUN_SSH_KEY }}
        port: ${{ secrets.ALIYUN_PORT }}
        script: |
          set -e  # é‡åˆ°ä»»ä½•é”™è¯¯ç«‹å³é€€å‡º
          set -o pipefail  # ç®¡é“å‘½ä»¤ä¸­ä»»ä½•ä¸€ä¸ªå¤±è´¥éƒ½ä¼šå¯¼è‡´æ•´ä¸ªç®¡é“å¤±è´¥
          
          echo "========================================="
          echo "å¼€å§‹éƒ¨ç½² Railway-PY åº”ç”¨..."
          echo "å½“å‰ç”¨æˆ·: $(whoami)"
          echo "å½“å‰æ—¶é—´: $(date)"
          echo "========================================="
          
          # æ£€æŸ¥Dockeræ˜¯å¦å®‰è£…å’Œè¿è¡Œ
          echo "æ­¥éª¤1: æ£€æŸ¥DockerçŠ¶æ€..."
          if ! docker --version; then
            echo "âŒ Dockeræœªå®‰è£…"
            exit 1
          fi
          
          if ! docker info > /dev/null 2>&1; then
            echo "âŒ DockeræœåŠ¡æœªè¿è¡Œ"
            exit 1
          fi
          echo "âœ… DockerçŠ¶æ€æ­£å¸¸"
          
          # è¿›å…¥éƒ¨ç½²ç›®å½•
          echo "æ­¥éª¤2: å‡†å¤‡éƒ¨ç½²ç›®å½•..."
          if ! cd /opt/railway-py 2>/dev/null; then
            echo "ç›®å½•ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
            if ! mkdir -p /opt/railway-py; then
              echo "âŒ åˆ›å»ºç›®å½•å¤±è´¥"
              exit 1
            fi
            if ! cd /opt/railway-py; then
              echo "âŒ è¿›å…¥ç›®å½•å¤±è´¥"
              exit 1
            fi
          fi
          echo "âœ… å½“å‰ç›®å½•: $(pwd)"
          
          # è·å–ä»£ç 
          echo "æ­¥éª¤3: è·å–ä»£ç ..."
          if [ ! -f "Dockerfile" ] || [ ! -f "requirements.txt" ]; then
            echo "æ­£åœ¨ä¸‹è½½ä»£ç ..."
            # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§æ–‡ä»¶
            rm -rf * .git* 2>/dev/null || true
            
            # ä¸‹è½½ä»£ç zipæ–‡ä»¶
            if ! wget -O railway-py.zip https://codeload.github.com/maius28/railway-py/zip/refs/heads/master; then
              echo "âŒ ä»£ç ä¸‹è½½å¤±è´¥"
              exit 1
            fi
            echo "âœ… ä»£ç ä¸‹è½½æˆåŠŸ"
            
            # è§£å‹ä»£ç æ–‡ä»¶
            if ! unzip -q railway-py.zip; then
              echo "âŒ ä»£ç è§£å‹å¤±è´¥"
              exit 1
            fi
            echo "âœ… ä»£ç è§£å‹æˆåŠŸ"
            
            # ç§»åŠ¨æ–‡ä»¶åˆ°å½“å‰ç›®å½•
            if ! mv railway-py-master/* . 2>/dev/null; then
              echo "âŒ æ–‡ä»¶ç§»åŠ¨å¤±è´¥"
              exit 1
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf railway-py.zip railway-py-master
            echo "âœ… ä»£ç éƒ¨ç½²æˆåŠŸ"
          else
            echo "å‘ç°å·²å­˜åœ¨çš„ä»£ç æ–‡ä»¶ï¼Œæ­£åœ¨æ›´æ–°..."
            # æ¸…ç†ç°æœ‰æ–‡ä»¶
            rm -rf * .git* 2>/dev/null || true
            
            # é‡æ–°ä¸‹è½½æœ€æ–°ä»£ç 
            if ! wget -O railway-py.zip https://codeload.github.com/maius28/railway-py/zip/refs/heads/master; then
              echo "âŒ ä»£ç ä¸‹è½½å¤±è´¥"
              exit 1
            fi
            
            if ! unzip -q railway-py.zip; then
              echo "âŒ ä»£ç è§£å‹å¤±è´¥"
              exit 1
            fi
            
            if ! mv railway-py-master/* . 2>/dev/null; then
              echo "âŒ æ–‡ä»¶ç§»åŠ¨å¤±è´¥"
              exit 1
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf railway-py.zip railway-py-master
            echo "âœ… ä»£ç æ›´æ–°æˆåŠŸ"
          fi
          
          # éªŒè¯å…³é”®æ–‡ä»¶
          echo "æ­¥éª¤4: éªŒè¯å…³é”®æ–‡ä»¶..."
          if [ ! -f "Dockerfile" ]; then
            echo "âŒ Dockerfileä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "requirements.txt" ]; then
            echo "âŒ requirements.txtä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f "docker-compose.yml" ]; then
            echo "âŒ docker-compose.ymlä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… å…³é”®æ–‡ä»¶éªŒè¯é€šè¿‡"
          
          # æ£€æŸ¥docker composeæ˜¯å¦å¯ç”¨
          echo "æ­¥éª¤5: æ£€æŸ¥docker compose..."
          if ! docker compose --version; then
            echo "âŒ docker composeæœªå®‰è£…"
            exit 1
          fi
          echo "âœ… docker composeçŠ¶æ€æ­£å¸¸"
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          echo "æ­¥éª¤6: åœæ­¢ç°æœ‰æœåŠ¡..."
          if docker compose ps -q | grep -q .; then
            echo "å‘ç°è¿è¡Œä¸­çš„æœåŠ¡ï¼Œæ­£åœ¨åœæ­¢..."
            if ! docker compose down; then
              echo "âŒ åœæ­¢æœåŠ¡å¤±è´¥"
              exit 1
            fi
            echo "âœ… æœåŠ¡å·²åœæ­¢"
          else
            echo "â„¹ï¸ æ²¡æœ‰è¿è¡Œä¸­çš„æœåŠ¡"
          fi
          
          # æ¸…ç†æ—§é•œåƒï¼ˆå¯é€‰ï¼‰
          echo "æ­¥éª¤7: æ¸…ç†æ—§é•œåƒ..."
          if docker images -q railway-py_railway-py | grep -q .; then
            echo "å‘ç°æ—§é•œåƒï¼Œæ­£åœ¨åˆ é™¤..."
            if ! docker rmi railway-py_railway-py; then
              echo "âš ï¸ åˆ é™¤æ—§é•œåƒå¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²"
            else
              echo "âœ… æ—§é•œåƒå·²åˆ é™¤"
            fi
          else
            echo "â„¹ï¸ æ²¡æœ‰æ—§é•œåƒéœ€è¦åˆ é™¤"
          fi
          
          # æ„å»ºå¹¶å¯åŠ¨æœåŠ¡
          echo "æ­¥éª¤8: æ„å»ºå¹¶å¯åŠ¨æœåŠ¡..."
          if ! docker compose up -d --build; then
            echo "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"
            echo "æŸ¥çœ‹æœåŠ¡æ—¥å¿—ï¼š"
            docker compose logs
            exit 1
          fi
          echo "âœ… æœåŠ¡å¯åŠ¨æˆåŠŸ"
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "æ­¥éª¤9: ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 30
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "æ­¥éª¤10: æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
          if ! docker compose ps | grep railway-py | grep -q "Up"; then
            echo "âŒ railway-pyæœåŠ¡æœªåœ¨è¿è¡ŒçŠ¶æ€"
            echo "æœåŠ¡æ—¥å¿—ï¼š"
            docker compose logs railway-py
            exit 1
          fi
          echo "âœ… æœåŠ¡è¿è¡Œæ­£å¸¸"
          
          # æµ‹è¯•æœåŠ¡
          echo "æ­¥éª¤11: æµ‹è¯•æœåŠ¡..."
          MAX_ATTEMPTS=5
          for i in $(seq 1 $MAX_ATTEMPTS); do
            echo "ç¬¬ $i æ¬¡æµ‹è¯•æœåŠ¡..."
            if curl -f http://localhost:8000/ping 2>/dev/null; then
              echo "âœ… æœåŠ¡å“åº”æ­£å¸¸"
              break
            else
              if [ $i -eq $MAX_ATTEMPTS ]; then
                echo "âŒ æœåŠ¡æµ‹è¯•å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                echo "æœåŠ¡æ—¥å¿—ï¼š"
                docker compose logs railway-py
                exit 1
              else
                echo "â³ æœåŠ¡æš‚æœªå“åº”ï¼Œç­‰å¾…é‡è¯•..."
                sleep 10
              fi
            fi
          done
          
          # æ¸…ç†Dockerç³»ç»Ÿ
          echo "æ­¥éª¤12: æ¸…ç†Dockerç³»ç»Ÿ..."
          if ! docker system prune -f; then
            echo "âš ï¸ Dockerç³»ç»Ÿæ¸…ç†å¤±è´¥ï¼Œä½†ä¸å½±å“éƒ¨ç½²"
          else
            echo "âœ… Dockerç³»ç»Ÿæ¸…ç†å®Œæˆ"
          fi
          
          echo "========================================="
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸå®Œæˆï¼"
          echo "æœåŠ¡çŠ¶æ€:"
          docker compose ps
          echo "railway-pyæœåŠ¡æ—¥å¿—ï¼ˆæœ€å10è¡Œï¼‰:"
          docker compose logs --tail 10 railway-py
          echo "è®¿é—®åœ°å€: http://æœåŠ¡å™¨IP:8000"
          echo "APIæ–‡æ¡£: http://æœåŠ¡å™¨IP:8000/docs"
          echo "æ•°æ®åº“åœ°å€: æœåŠ¡å™¨IP:3306"
          echo "========================================"